# üìÖ n8n: Configura√ß√£o de Email/WhatsApp com Google Calendar (.ics)

## üéØ Objetivo

Quando um agendamento √© criado, o **webhook** envia todos os dados para o **n8n**, que:
1. ‚úÖ Cria arquivo **.ics** (Google Calendar)
2. ‚úÖ Envia **email** da empresa com .ics anexo
3. ‚úÖ Envia **WhatsApp** com link para download do .ics

---

## üìä Dados Recebidos do Webhook

### **Evento:** `appointment_created`

```json
{
  "id": "abc-123-def-456",
  "agendamento_id": "abc-123-def-456",
  "data_hora": "2025-01-15T14:30:00+00:00",
  "created_at": "2025-01-10T10:00:00+00:00",
  
  "paciente": {
    "id": "pac-123",
    "nome": "Jo√£o Silva",
    "email": "joao@email.com",
    "telefone": "61999999999"
  },
  
  "responsavel_legal": {
    "id": "resp-456",
    "nome": "Maria Silva",
    "email": "maria@gmail.com",
    "telefone": "61988888888"
  },
  
  "profissional": {
    "id": "prof-789",
    "nome": "Dra. Bruna Cury",
    "email": "bruna@respirakids.com.br",
    "especialidade": "Fisioterapeuta",
    "telefone": "61977777777"
  },
  
  "tipo_servico": {
    "id": "serv-111",
    "nome": "Consulta de Fisioterapia",
    "duracao_minutos": 60,
    "valor": "250.00"
  },
  
  "local_atendimento": {
    "id": "local-222",
    "nome": "Cl√≠nica Lago Sul",
    "tipo_local": "clinica"
  },
  
  "status_consulta": {
    "id": "status-333",
    "codigo": "AGENDADO",
    "descricao": "Agendado"
  },
  
  "status_pagamento": {
    "id": "pag-444",
    "codigo": "PENDENTE",
    "descricao": "Pagamento Pendente"
  },
  
  "valor_servico": "250.00",
  "observacao": "Trazer exames anteriores",
  "ativo": true,
  
  "empresa_fatura": {
    "id": "emp-555",
    "razao_social": "Respira Kids Bras√≠lia LTDA",
    "nome_fantasia": "Respira Kids",
    "cnpj": "12.345.678/0001-90"
  }
}
```

---

## üìù Formato do Arquivo .ics

### **Estrutura B√°sica:**

```ics
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Respira Kids Bras√≠lia//Agendamentos//PT-BR
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:{{ agendamento_id }}@respirakidsbrasilia.com.br
DTSTAMP:{{ data_criacao_formatada }}
DTSTART:{{ data_hora_inicio_formatada }}
DTEND:{{ data_hora_fim_formatada }}
SUMMARY:{{ titulo_evento }}
LOCATION:{{ endereco_completo }}
DESCRIPTION:{{ descricao_completa }}
ORGANIZER;CN={{ nome_empresa }}:mailto:{{ email_empresa }}
STATUS:CONFIRMED
SEQUENCE:0
BEGIN:VALARM
TRIGGER:{{ tempo_lembrete }}
ACTION:DISPLAY
DESCRIPTION:{{ texto_lembrete }}
END:VALARM
END:VEVENT
END:VCALENDAR
```

---

## üîß Mapeamento de Campos

### **1. UID (Identificador √önico)**
```
UID:{{ agendamento_id }}@respirakidsbrasilia.com.br
```
**Exemplo:**
```
UID:abc-123-def-456@respirakidsbrasilia.com.br
```

### **2. DTSTAMP (Data de Cria√ß√£o)**
```
DTSTAMP:{{ created_at | format: 'YYYYMMDDTHHmmss' }}Z
```
**Exemplo:**
```
DTSTAMP:20250110T100000Z
```

### **3. DTSTART (In√≠cio do Evento)**
```
DTSTART:{{ data_hora | format: 'YYYYMMDDTHHmmss' }}
```
**‚ö†Ô∏è IMPORTANTE:** N√ÉO use 'Z' no final (√© hor√°rio local de Bras√≠lia)

**Exemplo:**
```
DTSTART:20250115T143000
```

### **4. DTEND (Fim do Evento)**
```typescript
// Calcular: data_hora + duracao_minutos
const inicio = new Date(data_hora);
const fim = new Date(inicio.getTime() + duracao_minutos * 60000);

DTEND:{{ fim | format: 'YYYYMMDDTHHmmss' }}
```
**Exemplo:**
```
DTEND:20250115T153000
```

### **5. SUMMARY (T√≠tulo)**
```
SUMMARY:Consulta de Fisioterapia - {{ paciente.nome }}
```
**Exemplo:**
```
SUMMARY:Consulta de Fisioterapia - Jo√£o Silva
```

### **6. LOCATION (Local)**

#### **Se `tipo_local === 'clinica'` ou `'externa'`:**
```javascript
// Buscar endere√ßo do local de atendimento
const location = await buscarEnderecoLocal(local_atendimento.id);
```

#### **Se `tipo_local === 'domiciliar'`:**
```javascript
// Buscar endere√ßo do paciente
const location = await buscarEnderecoPaciente(paciente.id);
```

**Formato:**
```
LOCATION:Logradouro\, N√∫mero\, Bairro\, Cidade\, Estado\, CEP
```
**‚ö†Ô∏è IMPORTANTE:** Escapar v√≠rgulas com `\,`

**Exemplo:**
```
LOCATION:SHIS QI 11 Conj. 9 Casa 2\, Lago Sul\, Bras√≠lia\, DF\, 71625-290
```

### **7. DESCRIPTION (Descri√ß√£o)**

```
DESCRIPTION:Ol√°\, {{ responsavel_legal.nome || paciente.nome }}!\n
\n
A sua pr√≥xima consulta foi marcada para {{ data_hora | format: 'DD/MM/YYYY' }} √†s {{ data_hora | format: 'HH:mm' }} e ser√° realizada no endere√ßo {{ location }}\n
\n
‚ö† Instru√ß√µes:\n
‚Ä¢ Traga as medica√ß√µes em uso\;\n
‚Ä¢ Em caso de febre\, administrar a medica√ß√£o orientada pelo m√©dico 1 hora antes da consulta\;\n
‚Ä¢ Evite desperd√≠cio e traga sua seringa do 1¬∫ atendimento\;\n
‚Ä¢ Chegue no hor√°rio agendado\;\n
‚Ä¢ Alimentar o beb√™/crian√ßa 30 min antes.\n
\n
‚ùå Cancelamentos < 12h: cobran√ßa de 50%% (Cl√°usula 4¬™).\n
\n
---\n
üë®‚Äç‚öïÔ∏è Profissional: {{ profissional.nome }}\n
üè• Tipo de Servi√ßo: {{ tipo_servico.nome }}\n
‚è±Ô∏è Dura√ß√£o: {{ tipo_servico.duracao_minutos }} minutos
{{ observacao ? '\nüìù Observa√ß√µes: ' + observacao : '' }}
```

**‚ö†Ô∏è IMPORTANTE:** Escapar caracteres especiais:
- V√≠rgula: `\,`
- Ponto e v√≠rgula: `\;`
- Quebra de linha: `\n`
- Porcentagem: `%%`

### **8. ORGANIZER (Organizador)**
```
ORGANIZER;CN=Respira Kids:mailto:contato@respirakidsbrasilia.com.br
```

### **9. VALARM (Lembrete)**

```javascript
// Calcular lembrete baseado no hor√°rio
const hora = new Date(data_hora).getHours();

let lembrete = '-PT3H'; // 3 horas antes (padr√£o)
if (hora === 7 || hora === 8) {
  lembrete = '-PT1H'; // 1 hora antes
} else if (hora === 9) {
  lembrete = '-PT2H'; // 2 horas antes
}
```

```ics
BEGIN:VALARM
TRIGGER:-PT1H
ACTION:DISPLAY
DESCRIPTION:Lembrete: Consulta em 1 hora
END:VALARM
```

---

## üìß Template de Email

### **Assunto:**
```
‚úÖ Consulta Agendada - {{ paciente.nome }}
```

### **Corpo HTML:**

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
    .logo { max-width: 200px; margin-bottom: 20px; }
    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; }
    .info-box { background: #f5f5f5; padding: 20px; border-radius: 8px; margin: 20px 0; }
    .info-row { margin: 10px 0; }
    .icon { margin-right: 10px; }
    .button { display: inline-block; background: #667eea; color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; margin: 20px 0; font-weight: bold; }
    .instructions { background: #fff3cd; padding: 15px; border-left: 4px solid #ffc107; margin: 20px 0; }
    .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <img src="https://app.respirakidsbrasilia.com.br/images/logos/logo-respira-kids.png" alt="Respira Kids" class="logo">
      <h1>Consulta Agendada</h1>
    </div>
    
    <div class="content">
      <p>Ol√°, <strong>{{ responsavel_legal.nome || paciente.nome }}</strong>! üëã</p>
      
      <p>A consulta do <strong>{{ paciente.nome }}</strong> foi agendada com sucesso:</p>
      
      <div class="info-box">
        <div class="info-row">
          <span class="icon">üìÖ</span>
          <strong>Data:</strong> {{ data_hora | format: 'DD/MM/YYYY' }}
        </div>
        <div class="info-row">
          <span class="icon">üïê</span>
          <strong>Hor√°rio:</strong> {{ data_hora | format: 'HH:mm' }} √†s {{ data_hora_fim | format: 'HH:mm' }}
        </div>
        <div class="info-row">
          <span class="icon">üìç</span>
          <strong>Local:</strong> {{ location }}
        </div>
        <div class="info-row">
          <span class="icon">üë®‚Äç‚öïÔ∏è</span>
          <strong>Profissional:</strong> {{ profissional.nome }}
        </div>
        <div class="info-row">
          <span class="icon">üè•</span>
          <strong>Tipo:</strong> {{ tipo_servico.nome }}
        </div>
        <div class="info-row">
          <span class="icon">‚è±Ô∏è</span>
          <strong>Dura√ß√£o:</strong> {{ tipo_servico.duracao_minutos }} minutos
        </div>
      </div>
      
      <div style="text-align: center;">
        <a href="#" class="button">üìÖ ADICIONAR AO MEU CALEND√ÅRIO</a>
        <p style="font-size: 12px; color: #666;">Ou clique no arquivo .ics anexo</p>
      </div>
      
      <div class="instructions">
        <h3>‚ö†Ô∏è Instru√ß√µes Importantes:</h3>
        <ul>
          <li>üîπ Traga as medica√ß√µes em uso;</li>
          <li>üîπ Em caso de febre, administrar a medica√ß√£o orientada pelo m√©dico 1 hora antes da consulta;</li>
          <li>üîπ Evite desperd√≠cio e traga sua seringa do 1¬∫ atendimento;</li>
          <li>üîπ Chegue no hor√°rio agendado;</li>
          <li>üîπ Alimentar o beb√™/crian√ßa 30 min antes.</li>
        </ul>
        <p><strong>‚ùå Cancelamentos com menos de 12 horas:</strong> cobran√ßa de 50% do valor (Cl√°usula 4¬™ do contrato).</p>
      </div>
      
      {{ observacao ? '<div class="info-box"><strong>üìù Observa√ß√µes:</strong><br>' + observacao + '</div>' : '' }}
    </div>
    
    <div class="footer">
      <p><strong>Respira Kids Bras√≠lia</strong></p>
      <p>üìû {{ profissional.telefone }} | üìß contato@respirakidsbrasilia.com.br</p>
      <p>üåê <a href="https://www.respirakidsbrasilia.com.br">www.respirakidsbrasilia.com.br</a></p>
    </div>
  </div>
</body>
</html>
```

---

## üì± Template de WhatsApp

```
üìÖ *Consulta Agendada - {{ paciente.nome }}*

Ol√°, {{ responsavel_legal.nome || paciente.nome }}! üëã

A consulta do *{{ paciente.nome }}* foi agendada:

üìÖ *Data:* {{ data_hora | format: 'DD/MM/YYYY' }}
üïê *Hor√°rio:* {{ data_hora | format: 'HH:mm' }} √†s {{ data_hora_fim | format: 'HH:mm' }}
üìç *Local:* {{ location }}
üë®‚Äç‚öïÔ∏è *Profissional:* {{ profissional.nome }}
üè• *Tipo:* {{ tipo_servico.nome }}

üìÖ *Adicionar ao calend√°rio:*
https://app.respirakidsbrasilia.com.br/agenda/add/{{ agendamento_id }}

‚ö†Ô∏è *Instru√ß√µes:*
‚Ä¢ Traga as medica√ß√µes em uso
‚Ä¢ Chegue no hor√°rio agendado
‚Ä¢ Alimentar crian√ßa 30min antes

‚ùå *Cancelamentos < 12h: cobran√ßa de 50%*

{{ observacao ? 'üìù *Obs:* ' + observacao + '\n\n' : '' }}D√∫vidas? Responda esta mensagem! üòä

---
*Respira Kids Bras√≠lia*
üìû {{ profissional.telefone }}
üåê www.respirakidsbrasilia.com.br
```

---

## üîß Workflow n8n (Exemplo)

### **Node 1: Webhook Trigger**
```javascript
// Recebe dados do Supabase
const webhook_data = $input.all();
```

### **Node 2: Buscar Endere√ßo**
```javascript
// Se tipo_local === 'clinica' ou 'externa'
if (tipo_local === 'clinica' || tipo_local === 'externa') {
  // Buscar no Supabase: locais_atendimento + enderecos
  const location = await fetchLocalAddress(local_atendimento.id);
}
// Se tipo_local === 'domiciliar'
else if (tipo_local === 'domiciliar') {
  // Buscar no Supabase: pessoas + enderecos
  const location = await fetchPatientAddress(paciente.id);
}
```

### **Node 3: Gerar arquivo .ics**
```javascript
const inicio = new Date(data_hora);
const fim = new Date(inicio.getTime() + duracao_minutos * 60000);
const hora = inicio.getHours();

let lembrete = '-PT3H';
if (hora === 7 || hora === 8) lembrete = '-PT1H';
else if (hora === 9) lembrete = '-PT2H';

const icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Respira Kids Bras√≠lia//PT-BR
CALSCALE:GREGORIAN
METHOD:PUBLISH
BEGIN:VEVENT
UID:${agendamento_id}@respirakidsbrasilia.com.br
DTSTAMP:${formatDate(created_at, 'YYYYMMDDTHHmmss')}Z
DTSTART:${formatDate(inicio, 'YYYYMMDDTHHmmss')}
DTEND:${formatDate(fim, 'YYYYMMDDTHHmmss')}
SUMMARY:Consulta de Fisioterapia - ${paciente.nome}
LOCATION:${location.replace(/,/g, '\\,')}
DESCRIPTION:${description.replace(/\n/g, '\\n')}
ORGANIZER;CN=Respira Kids:mailto:contato@respirakidsbrasilia.com.br
STATUS:CONFIRMED
BEGIN:VALARM
TRIGGER:${lembrete}
ACTION:DISPLAY
DESCRIPTION:Lembrete: Consulta em ${lembrete.replace('-PT', '').replace('H', 'h')}
END:VALARM
END:VEVENT
END:VCALENDAR`;

return { ics: icsContent };
```

### **Node 4: Enviar Email**
```javascript
// Gmail / SMTP
{
  to: responsavel_legal.email || paciente.email,
  from: 'Respira Kids <contato@respirakidsbrasilia.com.br>',
  subject: `‚úÖ Consulta Agendada - ${paciente.nome}`,
  html: emailTemplate,
  attachments: [
    {
      filename: `consulta_${paciente.nome.toLowerCase().replace(/ /g, '_')}.ics`,
      content: icsContent,
      contentType: 'text/calendar; charset=utf-8'
    }
  ]
}
```

### **Node 5: Enviar WhatsApp**
```javascript
// Evolution API / Baileys
{
  number: responsavel_legal.telefone || paciente.telefone,
  message: whatsappTemplate
}
```

---

## ‚úÖ Checklist

### **Configura√ß√£o:**
- [ ] Webhook `appointment_created` configurado
- [ ] n8n recebendo dados do webhook
- [ ] Queries para buscar endere√ßo (cl√≠nica/domiciliar)
- [ ] Gerador de .ics funcionando
- [ ] Template de email criado
- [ ] Template de WhatsApp criado
- [ ] SMTP configurado
- [ ] WhatsApp API configurada

### **Testes:**
- [ ] Criar agendamento ‚Üí webhook dispara
- [ ] .ics gerado corretamente
- [ ] Email enviado com .ics anexo
- [ ] WhatsApp enviado com link
- [ ] Arquivo .ics abre no Google Calendar
- [ ] Evento adicionado ao calend√°rio
- [ ] Lembretes funcionando

---

## üìö Refer√™ncias

- [RFC 5545 - iCalendar](https://tools.ietf.org/html/rfc5545)
- [Google Calendar .ics Format](https://developers.google.com/calendar/ical)
- [n8n Documentation](https://docs.n8n.io/)

---

**üéâ Pronto para configurar no n8n!**
